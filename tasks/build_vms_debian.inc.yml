- name: create file for customize the build
  template:
    src: ../templates/debian_build_commands.j2
    dest: "{{ virt_builder_customize_temp_file }}"

- name: build debian image {{ vm.name }}
  ansible.builtin.command:
    argv:
      - virt-builder
      - "{{ vm.os }}"
      - --size 
      - "{{ vm.size }}"
      - --hostname 
      - '{{ vm.name + "." + vm_domain_name }}'
      - --output 
      - '{{ vm_image_path + "/" + vm.name + ".qcow2" }}'
      - --format 
      - qcow2
      - --write
      - "/etc/network/interfaces.d/custom:{{ lookup('template', '../templates/debian_interfaces.j2') }}"
      - --write
      - "/etc/resolv.conf:{{ lookup('template', '../templates/resolv.conf.j2') }}"
      - --commands-from-file
      - "{{ virt_builder_customize_temp_file }}"
    creates: '{{ vm_image_path + "/" + vm.name + ".qcow2" }}'
  when: vm.type == "debian"

- name: install vm {{ vm.name }}
  ansible.builtin.command:
    argv:
      - virt-install
      - --name
      - "{{ vm.name }}"
      - --import
      - --ram
      - "{{ vm.ram }}"
      - --disk
      - '{{ vm_image_path + "/" + vm.name + ".qcow2" }}'
      - --osinfo
      - "{{ vm.osinfo }}"
      - --noautoconsole
      - --network
      - none
  when: 
    - vm.type == "debian"
    - vm.name not in existing_vms.list_vms

- name: pause because of troubles if boot is not finished
  ansible.builtin.pause:
    seconds: 5

- name: register existing nics in vm {{ vm.name }}
  ansible.builtin.command:
    argv:
      - virsh
      - domiflist
      - "{{ vm.name }}"
  register: existing_nics
  changed_when: false

- name: attach nics to {{ vm.name }}
  ansible.builtin.command:
    argv:
      - virsh
      - attach-interface
      - --domain
      - "{{ vm.name }}"
      - --type
      - network
      - --source
      - "{{ nic.vm_net }}"
      - --config
      - --mac
      - "{{ nic.mac }}"
  loop: "{{ vm.network }}"
  loop_control:
    loop_var: nic
  when: 
    - vm.type == "debian"
    - nic.mac not in existing_nics.stdout

- name: shutdown vm {{ vm.name }}
  community.libvirt.virt:
    name: "{{ vm.name }}"
    command: destroy

- name: start vm {{ vm.name }}
  community.libvirt.virt:
    name: "{{ vm.name }}"
    command: start
    autostart: true
